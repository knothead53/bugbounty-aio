<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>BugBounty AIO – Recon</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{--bg:#0f172a;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--accent:#22d3ee;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:20px;margin-bottom:18px}
    h1{margin:0 0 6px;font-size:28px}
    .muted{color:var(--muted)}
    label{display:block;margin:10px 0 6px}
    input,select,button{background:#0b1220;color:var(--text);border:1px solid #293244;border-radius:10px;padding:10px 12px}
    input,select{width:100%}
    button{cursor:pointer}
    .row{display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px}
    .actions{display:flex;gap:10px;margin-top:14px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #334155;color:#cbd5e1}
    pre{white-space:pre-wrap;word-break:break-word;background:#0b1220;border:1px solid #293244;border-radius:10px;padding:12px;overflow:auto}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .k{color:#93c5fd}.v{color:#fca5a5}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .tools-row{display:grid;grid-template-columns:1fr 320px;gap:12px;align-items:start}
    .small{font-size:13px;color:var(--muted)}
    a.file-link{color:var(--accent);text-decoration:none;margin-right:8px}
    .log{max-height:320px;overflow:auto;background:#071022;padding:8px;border-radius:8px;border:1px solid #1f2a3a}
    .btn-secondary{background:transparent;border:1px solid #334155;padding:8px 10px;border-radius:8px;color:var(--text)}
    .disabled{opacity:.5;pointer-events:none}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Recon UI -->
    <div class="card">
      <h1>BugBounty AIO <span class="pill">Tool Pack A</span></h1>
      <div class="muted">Lightweight recon: WHOIS, DNS, quick TCP connect, Sublist3r, HTTP(S) liveness.</div>
      <div class="row" style="margin-top:14px">
        <div>
          <label>Domain</label>
          <input id="domain" placeholder="example.com" />
        </div>
        <div>
          <label>Top ports</label>
          <select id="ports">
            <option value="20">20</option>
            <option value="40" selected>40</option>
            <option value="60">60</option>
            <option value="80">80</option>
          </select>
        </div>
        <div>
          <label>HTTP timeout (ms)</label>
          <select id="timeout">
            <option value="1500">1500</option>
            <option value="2000" selected>2000</option>
            <option value="3000">3000</option>
            <option value="5000">5000</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button id="run">Run Recon</button>
        <div id="status" class="muted"></div>
      </div>
    </div>

    <!-- Tools + Results -->
    <div class="tools-row" style="margin-bottom:18px">
      <div class="card">
        <h3>Tool Runner</h3>
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
          <input id="toolTarget" placeholder="target domain (example.com)" />
          <select id="toolSelect" style="width:180px">
            <option value="subfinder">subfinder (subdomains)</option>
            <option value="naabu">naabu (fast ports)</option>
            <option value="httpx">httpx (http probe)</option>
            <option value="nuclei">nuclei (templates)</option>
          </select>
          <button id="runToolBtn">Run Tool</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <button id="runFullScan">Run Full Scan (subfinder → naabu → httpx → nuclei)</button>
          <div class="small">Jobs stored under <code>/data/jobs/</code> on host</div>
        </div>

        <div class="small" style="margin-bottom:6px">Latest output</div>
        <pre id="toolOutput" class="log">No tool output yet.</pre>

        <div style="margin-top:10px">
          <strong>Jobs</strong>
          <div id="jobLinks" class="small" style="margin-top:8px">No jobs yet.</div>
        </div>

        <div id="reportArea" style="margin-top:12px;display:block">
          <!-- PDF link(s) will be injected here -->
        </div>
      </div>

      <!-- Existing results grid -->
      <div id="results" class="grid">
        <div class="card"><h3>Summary</h3><div id="summary" class="muted">No data yet.</div></div>
        <div class="card"><h3>Open Ports</h3><div id="portsBox" class="muted">No data yet.</div></div>
        <div class="card"><h3>WHOIS</h3><pre id="whois" class="muted">No data yet.</pre></div>
        <div class="card"><h3>Apex A Records</h3><pre id="apex" class="muted">No data yet.</pre></div>
        <div class="card"><h3>Subdomains</h3><pre id="subs" class="muted">No data yet.</pre></div>
        <div class="card"><h3>Alive Endpoints</h3><pre id="alive" class="muted">No data yet.</pre></div>
      </div>
    </div>

    <div class="card">
      <h3>Raw JSON</h3>
      <pre id="raw" class="muted">No data yet.</pre>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const fmt = o => JSON.stringify(o, null, 2);

    /* ---------------- Recon ---------------- */
    async function runRecon(){
      const domain = $('domain').value.trim();
      const top_ports = parseInt($('ports').value,10);
      const alive_timeout_ms = parseInt($('timeout').value,10);

      if(!domain){ $('status').textContent = 'Please enter a domain.'; return; }

      $('status').textContent = 'Running…';
      const started = performance.now();
      try{
        const res = await fetch('/recon', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({domain, top_ports, alive_timeout_ms})
        });
        const data = await res.json();

        $('raw').textContent = fmt(data);
        $('whois').textContent = fmt(data.whois || {});
        $('apex').textContent = (data.apex_A && data.apex_A.length) ? data.apex_A.join('\n') : '—';
        $('subs').textContent = (data.subdomains && data.subdomains.length) ? data.subdomains.join('\n') : '—';
        $('alive').textContent = (data.alive_endpoints && data.alive_endpoints.length)
          ? data.alive_endpoints.map(a=>`${a.url}  [${a.status} ${a.reason}]`).join('\n') : '—';
        $('portsBox').textContent = (data.open_ports_tcp_connect && data.open_ports_tcp_connect.length)
          ? data.open_ports_tcp_connect.join(', ') : '—';

        $('summary').innerHTML =
          `<div><span class="k">Target</span>: <span class="v">${data.target}</span></div>
           <div><span class="k">Subdomains</span>: <span class="v">${data.subdomains_count}</span></div>
           <div><span class="k">Alive endpoints</span>: <span class="v">${(data.alive_endpoints||[]).length}</span></div>`;

        const ms = Math.round(performance.now()-started);
        $('status').innerHTML = `<span class="ok">Done</span> in ${ms} ms`;
      }catch(e){
        $('status').innerHTML = `<span class="err">Failed</span>`;
        $('raw').textContent = String(e);
      }
    }

    $('run').addEventListener('click', runRecon);
    $('domain').addEventListener('keydown', (e)=>{ if(e.key==='Enter') runRecon(); });

    /* ---------------- Tool runner / pipeline ---------------- */
    async function apiPost(path, body){
      const res = await fetch(path, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      // Try to decode JSON, but provide clear error handling
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (err) {
        return { error: `Invalid JSON response from server (status ${res.status}).`, raw: text };
      }
    }

    async function runTool(tool, target, input_file = null){
      $('toolOutput').textContent = `Starting ${tool} on ${target}...\n`;
      try {
        const payload = { tool, target };
        if(input_file) payload.input_file = input_file;
        const resp = await apiPost('/run/tool', payload);
        if(resp.error){
          $('toolOutput').textContent = `Error: ${resp.error}\n${resp.log_snippet||''}`;
        } else {
          const header = `=== ${tool} (job ${resp.job_id}) exit=${resp.exit_code} ===\n`;
          $('toolOutput').textContent = header + (resp.log || '') + '\n';
          await refreshJobs(target);
        }
        return resp;
      } catch(e){
        $('toolOutput').textContent = "Error: " + e;
        return null;
      }
    }

    $('runToolBtn').addEventListener('click', ()=> {
      const tool = $('toolSelect').value;
      const target = $('toolTarget').value.trim() || $('domain').value.trim();
      if(!target){ $('toolOutput').textContent = 'Enter a target domain first.'; return; }
      runTool(tool, target);
    });

    /* ---------------- New: server-side pipeline via /run/pipeline ---------------- */
    async function runPipeline(target){
      // disable UI
      $('runFullScan').classList.add('disabled');
      $('toolOutput').textContent = `Starting full pipeline for ${target}...\nThis may take several minutes depending on target size.\n\n`;

      try {
        const resp = await apiPost('/run/pipeline', { target });

        if(resp.error){
          $('toolOutput').textContent += `Pipeline error: ${resp.error}\n${resp.log_snippet||''}`;
          $('runFullScan').classList.remove('disabled');
          return resp;
        }

        // Show per-tool results in the output area
        if(Array.isArray(resp.tools)){
          resp.tools.forEach(t => {
            $('toolOutput').textContent += `\n--- ${t.tool} (exit=${t.exit_code}) ---\n`;
            if(t.log) $('toolOutput').textContent += t.log + '\n';
          });
        }

        // If the server produced a report path, turn that into clickable links
        const reportPath = resp.report;
        const outDir = resp.out_dir || '';
        const jobId = resp.job_id || '';
        const reportArea = $('reportArea');
        reportArea.innerHTML = ''; // reset

        if(reportPath){
          // Build a safe download URL via /jobs/file endpoint
          const url = `/jobs/file?path=${encodeURIComponent(reportPath)}`;
          const openBtn = document.createElement('a');
          openBtn.href = url;
          openBtn.target = '_blank';
          openBtn.className = 'btn-secondary';
          openBtn.textContent = 'Open PDF';
          openBtn.style.marginRight = '8px';

          const dlBtn = document.createElement('a');
          dlBtn.href = url;
          dlBtn.className = 'btn-secondary';
          dlBtn.textContent = 'Download PDF';
          dlBtn.setAttribute('download', `bbug-${jobId || 'report'}.pdf`);

          reportArea.appendChild(openBtn);
          reportArea.appendChild(dlBtn);

          $('toolOutput').textContent += `\nReport created: ${reportPath}\n`;
        } else {
          $('toolOutput').textContent += `\nNo PDF generated. Check job folder: ${outDir}\n`;
        }

        // Refresh job list
        await refreshJobs(target);
        $('runFullScan').classList.remove('disabled');
        return resp;
      } catch (err) {
        $('toolOutput').textContent += `Pipeline failed: ${err}\n`;
        $('runFullScan').classList.remove('disabled');
        return null;
      }
    }

    $('runFullScan').addEventListener('click', async ()=>{
      const target = $('toolTarget').value.trim() || $('domain').value.trim();
      if(!target){ $('toolOutput').textContent = 'Enter a target domain first.'; return; }
      // Clear previous report area
      $('reportArea').innerHTML = '';
      await runPipeline(target);
    });

    /* ---------------- Jobs listing / file links ---------------- */
    async function refreshJobs(target){
      const r = await fetch(`/jobs/list/${encodeURIComponent(target)}`);
      const json = await r.json();
      const div = $('jobLinks');
      div.innerHTML = '';
      if(!json.jobs || json.jobs.length===0){
        div.textContent = 'No jobs yet.';
        return;
      }
      json.jobs.forEach(j=>{
        const wrapper = document.createElement('div');
        wrapper.style.marginBottom = '10px';
        const title = document.createElement('div');
        title.innerHTML = `<strong>${j.job}</strong>`;
        wrapper.appendChild(title);

        const list = document.createElement('div');
        list.style.marginTop = '6px';
        j.files.forEach(f=>{
          const a = document.createElement('a');
          const fullPath = `${j.path}/${f}`;
          a.href = `/jobs/file?path=${encodeURIComponent(fullPath)}`;
          a.textContent = f;
          a.className = 'file-link';
          a.target = '_blank';
          list.appendChild(a);
        });
        wrapper.appendChild(list);
        div.appendChild(wrapper);
      });
    }

    // Refresh jobs when user changes target or domain
    $('toolTarget').addEventListener('blur', ()=> {
      const t = $('toolTarget').value.trim() || $('domain').value.trim();
      if(t) refreshJobs(t);
    });
    $('domain').addEventListener('blur', ()=> {
      const t = $('toolTarget').value.trim() || $('domain').value.trim();
      if(t) refreshJobs(t);
    });

    // On load, try to populate jobs for domain field
    window.addEventListener('load', ()=> {
      const t = $('toolTarget').value.trim() || $('domain').value.trim();
      if(t) refreshJobs(t);
    });
  </script>
</body>
</html>
